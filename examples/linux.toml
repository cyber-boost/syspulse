# Linux-specific daemon examples
# Uses standard Unix paths, systemd-adjacent patterns, and Linux tooling.

[[daemon]]
name = "nginx-proxy"
command = ["/usr/sbin/nginx", "-g", "daemon off;", "-c", "/etc/nginx/nginx.conf"]
description = "Nginx reverse proxy running in foreground mode"
user = "www-data"
stop_timeout_secs = 30
tags = ["linux", "nginx", "proxy", "web"]

[daemon.health_check]
type = "http"
target = "http://127.0.0.1:80/healthz"
interval_secs = 10
timeout_secs = 3
retries = 3
start_period_secs = 5

[daemon.restart_policy]
policy = "always"
backoff_base_secs = 1
backoff_max_secs = 60

[daemon.resource_limits]
max_memory_bytes = 536870912    # 512 MB
max_open_files = 65536

[daemon.log_config]
max_size_bytes = 209715200      # 200 MB
retain_count = 14
compress_rotated = true

[[daemon]]
name = "gunicorn-app"
command = ["/usr/bin/gunicorn", "myapp.wsgi:application", "--bind", "0.0.0.0:8000", "--workers", "4", "--timeout", "120"]
working_dir = "/srv/myapp"
description = "Django application via Gunicorn"
user = "appuser"
stop_timeout_secs = 120
tags = ["linux", "python", "django", "api"]

[daemon.env]
DJANGO_SETTINGS_MODULE = "myapp.settings.production"
DATABASE_URL = "postgres:///myapp"
REDIS_URL = "redis://127.0.0.1:6379/0"
SECRET_KEY_FILE = "/run/secrets/django_secret"

[daemon.health_check]
type = "http"
target = "http://127.0.0.1:8000/api/health/"
interval_secs = 30
timeout_secs = 10
retries = 3
start_period_secs = 15

[daemon.restart_policy]
policy = "on_failure"
max_retries = 20
backoff_base_secs = 2
backoff_max_secs = 300

[daemon.resource_limits]
max_memory_bytes = 4294967296   # 4 GB
max_cpu_percent = 80.0
max_open_files = 4096

[daemon.log_config]
max_size_bytes = 104857600      # 100 MB
retain_count = 10
compress_rotated = true

[[daemon]]
name = "celery-worker"
command = ["/srv/myapp/.venv/bin/celery", "-A", "myapp", "worker", "--loglevel=info", "--concurrency=8"]
working_dir = "/srv/myapp"
description = "Celery background task worker"
user = "appuser"
tags = ["linux", "python", "celery", "worker"]

[daemon.env]
DJANGO_SETTINGS_MODULE = "myapp.settings.production"
C_FORCE_ROOT = "false"

[daemon.health_check]
type = "command"
target = "/srv/myapp/.venv/bin/celery -A myapp inspect ping"
interval_secs = 60
timeout_secs = 15
retries = 3

[daemon.restart_policy]
policy = "always"
max_retries = 50
backoff_base_secs = 5
backoff_max_secs = 300

[daemon.resource_limits]
max_memory_bytes = 2147483648   # 2 GB

[[daemon]]
name = "certbot-renew"
command = ["/usr/bin/certbot", "renew", "--quiet", "--deploy-hook", "systemctl reload nginx"]
description = "Let's Encrypt certificate renewal"
schedule = "0 3 * * 1"
tags = ["linux", "ssl", "certbot", "scheduled"]

[daemon.restart_policy]
policy = "on_failure"
max_retries = 2
backoff_base_secs = 60
backoff_max_secs = 600

[[daemon]]
name = "prometheus-node"
command = ["/usr/local/bin/node_exporter", "--web.listen-address=:9100"]
description = "Prometheus node exporter for system metrics"
tags = ["linux", "monitoring", "prometheus"]

[daemon.health_check]
type = "http"
target = "http://127.0.0.1:9100/metrics"
interval_secs = 30
timeout_secs = 5
retries = 3

[daemon.restart_policy]
policy = "always"
backoff_base_secs = 2
backoff_max_secs = 30
